@model dawazon2._0.Models.ProductFormViewModel

@{
    ViewData["Title"] = Model.IsEdit ? $"Editar «{Model.Name}»" : "Nuevo producto";
    string formAction = Model.IsEdit
        ? Url.Action("Edit", "ProductsMvc", new { id = Model.Id })!
        : Url.Action("Create", "ProductsMvc")!;
}

<div class="container my-5" style="max-width:760px">

    @* Breadcrumb *@
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-controller="ProductsMvc" asp-action="Index">Productos</a>
            </li>
            @if (Model.IsEdit)
            {
                <li class="breadcrumb-item">
                    <a asp-controller="ProductsMvc" asp-action="Detail" asp-route-id="@Model.Id">@Model.Name</a>
                </li>
            }
            <li class="breadcrumb-item active">@(Model.IsEdit ? "Editar" : "Nuevo")</li>
        </ol>
    </nav>

    <h2 class="mb-4">@(Model.IsEdit ? "Editar producto" : "Nuevo producto")</h2>

    @* Errores globales del modelo *@
    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger">
            <ul class="mb-0">
                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
        </div>
    }

    <form asp-action="@(Model.IsEdit ? "Edit" : "Create")"
          asp-controller="ProductsMvc"
          asp-route-id="@Model.Id"
          method="post"
          enctype="multipart/form-data">
        @Html.AntiForgeryToken()

        @* Nombre *@
        <div class="mb-3">
            <label asp-for="Name" class="form-label fw-semibold"></label>
            <input asp-for="Name" class="form-control" placeholder="Ej: Funko Pop Batman">
            <span asp-validation-for="Name" class="text-danger small"></span>
        </div>

        @* Precio y Stock en la misma fila *@
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label asp-for="Price" class="form-label fw-semibold"></label>
                <div class="input-group">
                    <input asp-for="Price" class="form-control" type="number" step="0.01" min="0">
                    <span class="input-group-text">€</span>
                </div>
                <span asp-validation-for="Price" class="text-danger small"></span>
            </div>
            <div class="col-md-6">
                <label asp-for="Stock" class="form-label fw-semibold"></label>
                <input asp-for="Stock" class="form-control" type="number" min="0">
                <span asp-validation-for="Stock" class="text-danger small"></span>
            </div>
        </div>

        @* Categoría *@
        <div class="mb-3">
            <label asp-for="Category" class="form-label fw-semibold"></label>
            @if (Model.AvailableCategories.Any())
            {
                <select asp-for="Category" asp-items="Model.AvailableCategories" class="form-select">
                    <option value="">— Selecciona una categoría —</option>
                </select>
            }
            else
            {
                <input asp-for="Category" class="form-control" placeholder="Ej: DC Comics">
            }
            <span asp-validation-for="Category" class="text-danger small"></span>
        </div>

        @* Descripción *@
        <div class="mb-3">
            <label asp-for="Description" class="form-label fw-semibold"></label>
            <textarea asp-for="Description" class="form-control" rows="4"
                      placeholder="Descripción del producto…"></textarea>
            <span asp-validation-for="Description" class="text-danger small"></span>
        </div>

        @* Imágenes *@
        <div class="mb-4">
            <label asp-for="Images" class="form-label fw-semibold"></label>
            <input name="Images" id="Images" class="form-control" type="file" accept="image/*"
                   multiple onchange="previewImages(event)">

            @* Previsualización nuevas imágenes *@
            <div id="imagePreviews" class="d-flex gap-2 flex-wrap mt-2"></div>

            @* Imágenes actuales (edición) *@
            @if (Model.IsEdit && Model.CurrentImages.Any())
            {
                <div class="mt-2">
                    <small class="text-muted">Imágenes actuales:</small>
                    <div class="d-flex gap-2 flex-wrap mt-1">
                        @foreach (var img in Model.CurrentImages)
                        {
                            <img src="@img" class="rounded border"
                                 style="height:80px; object-fit:cover;" alt="Imagen actual">
                        }
                    </div>
                </div>
            }
        </div>

        @* Botones *@
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-gradient">
                <i class="bi bi-check-lg me-1"></i>
                @(Model.IsEdit ? "Guardar cambios" : "Crear producto")
            </button>
            <a asp-controller="ProductsMvc"
               asp-action="@(Model.IsEdit ? "Detail" : "Index")"
               asp-route-id="@Model.Id"
               class="btn btn-outline-secondary">
                Cancelar
            </a>
        </div>
    </form>
</div>

@section Scripts {
<script>
    function previewImages(event) {
        const container = document.getElementById('imagePreviews');
        container.innerHTML = '';
        const files = event.target.files;
        for (const file of files) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.className = 'rounded border';
            img.style.cssText = 'height:100px; object-fit:cover;';
            img.alt = file.name;
            container.appendChild(img);
        }
    }
</script>
}
